---
- name: Destroy K8S cluster (Stop and clean Control Node & worker nodes)
  hosts: k8s
  become: yes
  tags:
    - k8s_cluster_del
  vars:
    ansible_become_password: "{{ansible_password}}"
  tasks:
    - name: Stop Kubelet (sudo)
      ansible.builtin.command:
        cmd: "systemctl stop kubelet"
      ignore_errors: true
    - name: Reset the previous K8S installation (sudo)
      ansible.builtin.command:
        cmd: "kubeadm reset -f"
      ignore_errors: true

    - name: remove kubernetes configs (sudo)
      ansible.builtin.file:
        path: /etc/kubernetes
        state: absent
    - name: remove kubernetes Directories part 1 (sudo)
      ansible.builtin.file:
        path: /var/lib/etcd
        state: absent
    - name: remove kubernetes Directories part 2 (sudo)
      ansible.builtin.file:
        path: /var/lib/kubelet
        state: absent
    - name: remove kubernetes Directories part 3 (sudo)
      ansible.builtin.file:
        path: /var/lib/dockershim
        state: absent
    - name: remove kubernetes Directories part 4 (sudo)
      ansible.builtin.file:
        path: /var/run/kubernetes
        state: absent

    - name: Remove the CNI configs part 1 (sudo)
      ansible.builtin.file:
        path: /var/lib/cni
        state: absent
    - name: Remove the CNI configs part 2 (sudo)
      ansible.builtin.file:
        path: /etc/cni
        state: absent
    - name: remove dir with k8s config - master only (sudo)
      when: "'k8s_masters' in group_names"
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.kube"
        state: absent


- name: Remove K8S tools from VMs
  hosts: k8s
  become: yes
  tags:
    - k8s_tools_del
  vars:
    ansible_become_password: "{{ansible_password}}"
  tasks:
    - name: Unhold kubelet (sudo)
      ansible.builtin.dpkg_selections:
        name: kubelet
        selection: install
      ignore_errors: true
    - name: Unhold kubeadm (sudo)
      ansible.builtin.dpkg_selections:
        name: kubeadm
        selection: install
      ignore_errors: true
    - name: Unhold kubectl (sudo)
      ansible.builtin.dpkg_selections:
        name: kubectl
        selection: install
      ignore_errors: true
    - name: disable kubelet (sudo)
      ansible.builtin.service:
        name: kubelet
        enabled: no
      ignore_errors: true

    - name: Remove Kubernetes Tools (sudo)
      ansible.builtin.apt:
        pkg:
        - kubelet
        - kubeadm
        - kubectl
        state: absent
    - name: apt update after K8s tools del (sudo)
      ansible.builtin.apt:
        update_cache: yes
    - name: remove K8S APT repo (sudo)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/kubernetes.list
        state: absent
    - name: remove K8S public GPG Signing Key (sudo)
      ansible.builtin.file:
        path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        state: absent
    - name: remove containerd config (sudo)
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: absent

- name: remove containerd
  hosts: k8s
  become: yes
  tags:
    - containerd_del
  vars:
    ansible_become_password: "{{ansible_password}}"
  tasks:
    - name: remove containerd config dir (sudo)
      ansible.builtin.file:
        path: /etc/containerd
        state: absent
    - name: Uninstall containerd package (sudo)
      ansible.builtin.apt:
        name: containerd.io
        state: absent
    - name: apt update after containerd del (sudo)
      ansible.builtin.apt:
        update_cache: yes

    - name: remove docker public GPG Signing Key (sudo)
      ansible.builtin.file:
        path: /etc/apt/trusted.gpg.d/docker.gpg
        state: absent
    - name: remove docker APT repo 1 (sudo)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent
    - name: remove docker APT repo 2 (sudo)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/archive_uri-https_download_docker_com_linux_ubuntu-noble.list
        state: absent

    - name: uninstall containerd dependencies (sudo)
      ansible.builtin.apt:
        pkg:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg
        - software-properties-common
        state: absent
    - name: apt update after containerd deps del (sudo)
      ansible.builtin.apt:
        update_cache: yes
